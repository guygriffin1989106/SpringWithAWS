name: Perform Release with Artifactory

on:
  workflow_call:
    inputs:
      releaseVersion:
        description: 'Release version like 3.0.0-M1, 3.1.0-RC1, 3.2.0 etc.'
        required: true
        type: string
      buildToolArgs:
        description: 'Additional Maven or Gradle command arguments: tasks, goals, plugins etc. The `install` for Maven is included. The `build` and `artifactoryPublish` for Gradle are included.'
        required: false
        type: string
      repositoryTeam:
        description: 'Comma-separate GitHub user names for repository team members to exclude from contributors'
        required: false
        type: string

run-name: Release version ${{ inputs.releaseVersion }}

jobs:
  staging:
    uses: spring-projects/spring-integration-aws/.github/workflows/spring-stage-release.yml@main
    with:
      releaseVersion: ${{ inputs.releaseVersion }}
      buildToolArgs: ${{ inputs.buildToolArgs }}
    secrets: inherit

  verify-staged:
    needs: staging
    uses: ./.github/workflows/verify-staged-artifacts.yml
    with:
      releaseVersion: ${{ inputs.releaseVersion }}
    secrets: inherit

  promote-milestone:
    needs: [staging, verify-staged]
    if: ${{ (contains(inputs.releaseVersion, '-M') || contains(inputs.releaseVersion, '-RC')) }}
    uses: spring-projects/spring-integration-aws/.github/workflows/spring-artifactory-promote-milestone.yml@main
    with:
      buildName: ${{ needs.staging.outputs.buildName }}
      buildNumber: ${{ needs.staging.outputs.buildNumber }}
    secrets: inherit

  promote-ga:
    needs: [staging, verify-staged]
    if: ${{ !contains(inputs.releaseVersion, '-') }}
    uses: spring-projects/spring-integration-aws/.github/workflows/spring-artifactory-promote-central.yml@main
    with:
      buildName: ${{ needs.staging.outputs.buildName }}
      buildNumber: ${{ needs.staging.outputs.buildNumber }}
    secrets: inherit

  finalize:
    if: ${{ !(failure() || cancelled()) }}
    needs: [promote-milestone, promote-ga]
    uses: spring-projects/spring-integration-aws/.github/workflows/spring-finalize-release.yml@main
    with:
      milestone: ${{ inputs.releaseVersion }}
      repositoryTeam: ${{ inputs.repositoryTeam }}
    secrets: inherit