name: Perform Release with Artifactory

on:
  workflow_call:
    inputs:
      buildToolArgs:
        description: 'Additional Maven or Gradle command arguments: tasks, goals, plugins etc. The `install` for Maven is included. The `build` and `artifactoryPublish` for Gradle are included.'
        required: false
        type: string
      repositoryTeam:
        description: 'Comma-separate GitHub user names for repository team members to exclude from contributors'
        required: false
        type: string

jobs:
  releaseVersion:
    runs-on: ubuntu-latest
    outputs:
      releaseVersion: ${{ steps.release-version.outputs.releaseVersion }}

    steps:

      - uses: actions/checkout@v4
        with:
          show-progress: false

      - name: Find Current Version to Release
        id: release-version
        run: |
          if test -f pom.xml
          then
            CURRENT_VERSION=$(./mvnw help:evaluate -Dexpression="project.version" -q -DforceStdout)
          else
            CURRENT_VERSION=$(./gradlew properties --no-daemon --console=plain -q | grep "^version:" | awk '{printf $2}')
          fi
          export CANDIDATE_VERSION=${CURRENT_VERSION/-SNAPSHOT}
          RELEASE_VERSION=$(gh api repos/$GITHUB_REPOSITORY/milestones --jq 'map(select(.title | startswith(env.CANDIDATE_VERSION))) | .[0] | .title')
          echo releaseVersion=$RELEASE_VERSION >> $GITHUB_OUTPUT
          echo "::notice ::RELEASE VERSION=$RELEASE_VERSION"

  perform-release:
    needs: releaseVersion
    uses: spring-projects/spring-integration-aws/.github/workflows/spring-artifactory-release.yml@main
    with:
      releaseVersion: ${{ needs.releaseVersion.outputs.releaseVersion }}
      buildToolArgs: ${{ inputs.buildToolArgs }}
      repositoryTeam: ${{ inputs.repositoryTeam }}
    secrets: inherit
